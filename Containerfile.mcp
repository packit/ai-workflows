FROM fedora:42

# Install system dependencies
RUN dnf -y install \
      python3 \
      python3-aiofiles \
      python3-aiohttp \
      python3-copr \
      python3-ogr \
      python3-pip \
      python3-redis \
      python3-requests \
      python3-GitPython \
      krb5-libs \
      krb5-workstation \
      centpkg \
      git \
    && dnf clean all

# Install FastMCP
RUN pip3 install --no-cache-dir fastmcp

# Create user
RUN useradd -m -G wheel mcp

# Copy required directories
# Individual directories are mounted as volumes in development
COPY mcp_server/ /home/mcp/mcp_server/
COPY common/ /home/mcp/common/
RUN chgrp -R root /home/mcp && chmod -R g+rwX /home/mcp
RUN mkdir /git-repos && chmod -R o+rwX /git-repos

# Install RH IT Root CAs for lookaside cache access
COPY files/Current-IT-Root-CAs.pem /etc/pki/ca-trust/source/anchors/
RUN update-ca-trust

# Configure jump host for internal dist-git
RUN cat > /etc/ssh/ssh_config.d/00-dist-git.conf <<EOF
Host iad2
   Hostname bastion-iad2.corp.redhat.com
   GSSAPIAuthentication yes
Host pkgs.devel.redhat.com
   ProxyJump iad2
EOF
# Set up internal dist-git and GitLab SSH host keys
COPY files/internal_dist-git_host_keys /etc/ssh/ssh_known_hosts
RUN ssh-keyscan bastion-iad2.corp.redhat.com gitlab.com >> /etc/ssh/ssh_known_hosts

USER mcp
ENV HOME=/home/mcp
WORKDIR $HOME

ENV PYTHONPATH=$HOME:$PYTHONPATH

CMD ["/bin/bash"]
